# Афиша мероприятий — Event Board API

API для приложения “Афиша мероприятий” — просмотр мероприятий, бронирование мест и получение уведомлений.

---

## Описание проекта

Это REST API для управления событиями и бронированиями с системой уведомлений.

Пользователи могут:

- Зарегистрироваться и авторизоваться в сервисе (JWT)
- Просматривать все мероприятия с сортировкой и фильтрацией
- Просматривать подробности мероприятия
- Создавать мероприятия
- Изменять статус и удалять мероприятия (только организатор и с ограничением по времени)
- Бронировать и отменять участие в мероприятии
- Получать уведомления (о бронировании, об отмене бронирования и напоминание за час до мероприятия)
- Оценивать мероприятия (только прошедшие и только участники)

---

## Используемые технологии

- Python 3.10+
- Django 4.x + Django REST Framework
- djangorestframework-simplejwt (JWT аутентификация)
- Celery + Redis (фоновая обработка уведомлений и смены статуса)
- PostgreSQL (БД)
- drf-yasg (Swagger документация)
- Docker + docker-compose (контейнеризация)

---

## Модели

- **User** — стандартная модель Django
- **Event** - модель мероприятия
  - title (название)  
  - description (описание)  
  - start_time (время начала мероприятия)  
  - location (город)  
  - seats (количество мест)  
  - status (ожидается, отменено, завершено)  
  - organizer (FK на User)
- **Notification** — уведомления о бронировании, отмене, напоминании  
- **Booking** — бронь пользователя на мероприятие  
- **Tag**  — теги для мероприятий  
- **Rating**  — оценки мероприятий участниками

---

## Основной функционал

- **Админ-панель** с практически полным функционалом, описанным ниже
- **Просмотр мероприятий** с сортировкой по статусу, времени и средней оценке 
- **Фильтрация мероприятий** по локации, свободным местам, дате, статусу, тегам и средней оценке  
- **Создание, редактирование и удаление мероприятий** (редактирование и удаление возможно только в течение 1 часа после создания и только организатором)  
- **Бронирование и отмена брони**  
- **Оценка мероприятий** (только прошедших и только от участников)  
- **Уведомления пользователям** (создание и отмена брони, напоминания за час до начала)  
- **Регулярная задача смены статуса мероприятий** с "ожидается" на "завершено" (через 2 часа после начала, выполняется каждые 3 часа)
- **Регулярная задача отправки уведомления-напоминания** за 1 час до мероприятия
- **Асинхронная обработка уведомлений и смены статуса** с разделением приоритетов задач в Celery

---

## Запуск проекта

### Локально

1**Клонировать репозиторий:**

```bash
git clone https://github.com/yourusername/event_board_itorum.git
cd event_board_itorum
```

2**Создать файл .env и заполнить его данными из файла .env.sample**

3**Запустить с помощью Docker:**

```bash
uv run docker-compose up --build
```
В docker-compose настроены контейнеры для Django, PostgreSQL, Redis и Celery.

4**Сервер будет доступен по адресу:**

```arduino
http://0.0.0.0:8000/
```

## Документация API
Swagger UI доступен по адресу:

```bash
http://0.0.0.0:8000/swagger/
```
## Авторизация
Используется JWT аутентификация.
Для доступа к защищенным ресурсам добавьте в заголовок запроса:

```makefile
Authorization: Bearer <access_token>
```

## Основные эндпоинты

| Метод  | Путь                               | Описание                                                                |
|--------|------------------------------------|-------------------------------------------------------------------------|
| GET    | `/api/events/`                     | Список всех мероприятий с фильтрацией и сортировкой                     |
| GET    | `/api/events/{id}/`                | Детали мероприятия по ID                                                |
| POST   | `/api/events/`                     | Создание события                                                        |
| PATCH  | `/api/events/{id}/`                | Обновление события (только организатор)                                 |
| DELETE | `/api/events/{id}/`                | Удаление события организатором (только в течение 1 часа после создания) |
| POST   | `/api/events/{id}/book/`           | Забронировать участие в событии                                         |
| POST   | `/api/events/{id}/cancel_booking/` | Отменить бронь                                                          |
| POST   | `/api/events/{id}/rate/`           | Поставить оценку событию (только участники и только прошедшие)          |
| GET    | `/api/events/my_upcoming_events/`  | Список предстоящих событий пользователя                                 |
| GET    | `/api/notifications/`              | Просмотр уведомлений                                                    |
| GET    | `/api/tags/`                       | Просмотр тегов                                                          |
| POST   | `/api/users/register/`             | Регистрация пользователя                                                |
| POST   | `/api/users/login/`                | Логин и получение JWT токенов                                           |
| POST   | `/api/users/token/refresh/`        | Получение нового access токена                                          |
| POST   | `/api/swagger/`                    | Документация Swagger                                                    |
| POST   | `/api/redoc/`                      | Документация Redoc                                                      |


## Тестирование
Код покрыт тестами с покрытием более 85%. Для запуска тестов выполните команду:
```bash
uv run pytest
```


## Особенности
- Асинхронная обработка уведомлений и смены статуса событий через Celery с разделением приоритетов (срочные уведомления и фоновая смена статусов)

- Фильтрация по локации, тегам, статусу, дате и свободным местам

- Оценки событий учитываются при сортировке

- Уведомления реализованы через функцию-заглушку с выводом в логи (в дальнейшем можно подключить внешние сервисы)

- Добавлена кастомная команда для создания суперпользователя (csu). Под этим суперпользователем можно выполнять администрирование в админ панели.

## Возможные доработки
- В дальнейшем можно будет реализовать отправку уведомлений через email или смс (сейчас уведомления выводятся в терминал)

- Добавить концепцию Transaction Outbox для уведомлений о бронировании и отмены бронирования. 
Это нужно для того, чтобы в случае внезапного сбоя на стороне сервера, мы не теряли событие, либо чтобы событие не висело в воздухе
